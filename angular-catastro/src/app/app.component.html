<!-- Header -->
<header class="app-header">
  <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
    <div>
      <h1>üìã Valoraci√≥n de Propiedades Catastrales</h1>
      <p class="subtitle">
        Sistema de valoraci√≥n basado en cultivos y tasaciones oficiales
        <span *ngIf="usandoValoresPersonalizados()" style="color: #f59e0b; font-weight: bold; margin-left: 1rem;">
          ‚öôÔ∏è Usando valores personalizados
        </span>
      </p>
    </div>
    <button
      class="btn btn-config"
      (click)="abrirConfiguracion()"
      title="Configurar valores de tasaci√≥n"
    >
      ‚öôÔ∏è Configuraci√≥n
    </button>
  </div>
</header>

<div class="container">

  <!-- Loading indicator -->
  <div *ngIf="cargandoDatos" class="loading">
    <div class="spinner"></div>
    <p>Cargando datos catastrales y calculando valoraciones...</p>
  </div>

  <!-- Resumen general -->
  <section *ngIf="propiedades.length > 0 && !cargandoDatos" class="summary-section">
    <h2>Resumen General</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ propiedades.length }}</div>
        <div class="stat-label">Propiedades Totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCurrency(resultadoValoracion?.valor_total_estimado || 0) }}</div>
        <div class="stat-label">Valor Total Calculado</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ opcionesMunicipio.length }}</div>
        <div class="stat-label">Municipios</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ opcionesProvincia.length }}</div>
        <div class="stat-label">Provincias</div>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section *ngIf="propiedades.length > 0 && !cargandoDatos" class="filters-section">
    <h2>Filtros</h2>
    <div class="filters-grid">
      <div class="filter-item">
        <label for="filterClase">Clase</label>
        <select
          id="filterClase"
          class="filter-select"
          [(ngModel)]="filtros.clase"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let clase of opcionesClase" [value]="clase">{{ clase }}</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterProvincia">Provincia</label>
        <select
          id="filterProvincia"
          class="filter-select"
          [(ngModel)]="filtros.provincia"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let provincia of opcionesProvincia" [value]="provincia">{{ provincia }}</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterMunicipio">Municipio</label>
        <select
          id="filterMunicipio"
          class="filter-select"
          [(ngModel)]="filtros.municipio"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let municipio of opcionesMunicipio" [value]="municipio">{{ municipio }}</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterUso">Uso Principal</label>
        <select
          id="filterUso"
          class="filter-select"
          [(ngModel)]="filtros.uso"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let uso of opcionesUso" [value]="uso">{{ uso }}</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Buscador -->
  <section *ngIf="propiedades.length > 0 && !cargandoDatos" class="search-section">
    <h2>Buscar</h2>
    <input
      type="text"
      id="searchInput"
      [(ngModel)]="filtros.busqueda"
      (input)="aplicarFiltros()"
      placeholder="Buscar por referencia catastral, partida, municipio..."
    >
    <p class="help-text">
      Mostrando {{ propiedadesFiltradas.length }} de {{ propiedades.length }} propiedades
    </p>
  </section>

  <!-- Lista de propiedades -->
  <section *ngIf="propiedadesFiltradas.length > 0 && !cargandoDatos" class="properties-section">
    <div class="properties-header">
      <h2>Propiedades y Valoraciones</h2>
      <div class="properties-controls">
        <!-- Toggle vista -->
        <div class="view-toggle">
          <button
            class="btn-vista"
            [class.active]="vistaActual === 'tabla'"
            (click)="cambiarVista('tabla')"
          >
            üìä Tabla Detalle
          </button>
          <button
            class="btn-vista"
            [class.active]="vistaActual === 'resumen'"
            (click)="cambiarVista('resumen')"
          >
            üìã Tabla Resumen
          </button>
          <button
            class="btn-vista"
            [class.active]="vistaActual === 'tarjetas'"
            (click)="cambiarVista('tarjetas')"
          >
            üóÇÔ∏è Tarjetas
          </button>
        </div>
        <!-- Bot√≥n exportar -->
        <button
          class="btn btn-sec"
          style="background: #059669; color: white;"
          (click)="exportarAExcel()"
        >
          üìã Copiar para Excel
        </button>
      </div>
    </div>

    <!-- Vista de Tabla -->
    <div *ngIf="vistaActual === 'tabla'" class="properties-table-container">
      <table class="properties-data-table">
        <thead>
          <tr>
            <th>Catastro</th>
            <th>Ref. Catastral</th>
            <th>Provincia</th>
            <th>Municipio</th>
            <th>Partida</th>
            <th>Pol√≠gono</th>
            <th>Parcela</th>
            <th>Clase</th>
            <th>Uso</th>
            <th>Escritura</th>
            <th>Subparcela</th>
            <th>Cultivo/Aprovechamiento</th>
            <th>C√≥digo</th>
            <th>Sup. (m¬≤)</th>
            <th>Sup. (ha)</th>
            <th>‚Ç¨/ha</th>
            <th>Valor ‚Ç¨</th>
            <th>Valor Total Calculado ‚Ç¨</th>
            <th>Valor Catastral Oficial ‚Ç¨</th>
            <th>Diferencia ‚Ç¨</th>
            <th>Diferencia %</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let propiedad of propiedadesFiltradas">
            <ng-container *ngIf="propiedad.cultivos && propiedad.cultivos.length > 0; else sinCultivos">
              <tr
                *ngFor="let cultivo of propiedad.cultivos; let i = index"
                [class.first-row]="i === 0"
                [class.subparcela-row]="i > 0"
              >
                <td *ngIf="i === 0" [attr.rowspan]="propiedad.cultivos!.length" class="btn-cell">
                  <button class="btn-catastro" (click)="abrirCatastro(propiedad)" title="Ver en Catastro">
                    üîó
                  </button>
                </td>
                <td class="ref-catastral">{{ propiedad.referencia_catastral }}</td>
                <td>{{ propiedad.localizacion?.provincia }}</td>
                <td>{{ propiedad.localizacion?.municipio }}</td>
                <td>{{ propiedad.localizacion?.partida }}</td>
                <td>{{ propiedad.localizacion?.poligono }}</td>
                <td>{{ propiedad.localizacion?.parcela }}</td>
                <td>{{ propiedad.datos_inmueble?.clase }}</td>
                <td>{{ propiedad.datos_inmueble?.uso_principal }}</td>
                <td class="escritura">{{ propiedad.escritura }}</td>
                <td>{{ cultivo.subparcela }}</td>
                <td class="cultivo">{{ cultivo.cultivo_aprovechamiento }}</td>
                <ng-container *ngIf="getValoracion(propiedad.referencia_catastral) as valoracion">
                  <ng-container *ngIf="valoracion.detalles_cultivos && valoracion.detalles_cultivos[i] as detalle">
                    <td class="codigo">{{ detalle.codigo_catastral }}</td>
                    <td class="numeric">{{ cultivo.superficie_m2 }}</td>
                    <td class="numeric">{{ detalle.superficie_ha.toFixed(4) }}</td>
                    <td class="numeric">{{ formatNumber(detalle.precio_ha) }}</td>
                    <td class="numeric">{{ formatCurrency(detalle.valor_estimado) }}</td>
                  </ng-container>
                  <ng-container *ngIf="!valoracion.detalles_cultivos || !valoracion.detalles_cultivos[i]">
                    <td></td><td></td><td></td><td></td><td></td>
                  </ng-container>
                  <ng-container *ngIf="i === 0">
                    <td class="numeric valor-calculado">{{ formatCurrency(valoracion.valor_estimado_euros) }}</td>
                    <td class="numeric valor-oficial">{{ formatCurrency(propiedad.valor_referencia) }}</td>
                    <ng-container *ngIf="propiedad.valor_referencia as valorOficial">
                      <td class="numeric"
                          [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                          [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                        {{ formatCurrency((valoracion.valor_estimado_euros || 0) - valorOficial) }}
                      </td>
                      <td class="numeric"
                          [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                          [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                        {{ (((valoracion.valor_estimado_euros || 0) - valorOficial) / valorOficial * 100).toFixed(2) }}%
                      </td>
                    </ng-container>
                    <ng-container *ngIf="!propiedad.valor_referencia">
                      <td class="numeric">-</td><td class="numeric">-</td>
                    </ng-container>
                  </ng-container>
                  <ng-container *ngIf="i > 0">
                    <td></td><td></td><td></td><td></td>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!getValoracion(propiedad.referencia_catastral)">
                  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </ng-container>
              </tr>
            </ng-container>
            <ng-template #sinCultivos>
              <tr class="first-row">
                <td class="btn-cell">
                  <button class="btn-catastro" (click)="abrirCatastro(propiedad)" title="Ver en Catastro">
                    üîó
                  </button>
                </td>
                <td class="ref-catastral">{{ propiedad.referencia_catastral }}</td>
                <td>{{ propiedad.localizacion?.provincia }}</td>
                <td>{{ propiedad.localizacion?.municipio }}</td>
                <td>{{ propiedad.localizacion?.partida }}</td>
                <td>{{ propiedad.localizacion?.poligono }}</td>
                <td>{{ propiedad.localizacion?.parcela }}</td>
                <td>{{ propiedad.datos_inmueble?.clase }}</td>
                <td>{{ propiedad.datos_inmueble?.uso_principal }}</td>
                <td class="escritura">{{ propiedad.escritura }}</td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <ng-container *ngIf="getValoracion(propiedad.referencia_catastral) as valoracion">
                  <td class="numeric valor-calculado">{{ formatCurrency(valoracion.valor_estimado_euros) }}</td>
                  <td class="numeric valor-oficial">{{ formatCurrency(propiedad.valor_referencia) }}</td>
                  <ng-container *ngIf="propiedad.valor_referencia as valorOficial">
                    <td class="numeric"
                        [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                        [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                      {{ formatCurrency((valoracion.valor_estimado_euros || 0) - valorOficial) }}
                    </td>
                    <td class="numeric"
                        [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                        [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                      {{ (((valoracion.valor_estimado_euros || 0) - valorOficial) / valorOficial * 100).toFixed(2) }}%
                    </td>
                  </ng-container>
                  <ng-container *ngIf="!propiedad.valor_referencia">
                    <td class="numeric">-</td><td class="numeric">-</td>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!getValoracion(propiedad.referencia_catastral)">
                  <td></td><td></td><td></td><td></td>
                </ng-container>
              </tr>
            </ng-template>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Vista de Tarjetas -->
    <div *ngIf="vistaActual === 'tarjetas'" class="properties-list">
      <div
        *ngFor="let propiedad of propiedadesFiltradas"
        class="property-card"
      >
        <div class="property-header">
          <div>
            <div class="property-ref">{{ propiedad.referencia_catastral }}</div>
            <div class="property-location">
              {{ propiedad.localizacion?.partida }} -
              {{ propiedad.localizacion?.municipio }}
              ({{ propiedad.localizacion?.provincia }})
            </div>
            <div *ngIf="propiedad.escritura" class="property-escritura">
              {{ propiedad.escritura }}
            </div>
          </div>
          <button class="btn-catastro-card" (click)="abrirCatastro(propiedad)" title="Ver en Catastro">
            üîó Catastro
          </button>
        </div>
        <div class="property-details">
          <div class="detail-item">
            <span class="detail-label">Clase</span>
            <span class="detail-value">{{ propiedad.datos_inmueble?.clase || 'N/A' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Uso</span>
            <span class="detail-value">{{ propiedad.datos_inmueble?.uso_principal || 'N/A' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Pol√≠gono/Parcela</span>
            <span class="detail-value">{{ propiedad.localizacion?.poligono }}/{{ propiedad.localizacion?.parcela }}</span>
          </div>

          <!-- Cultivos -->
          <div *ngIf="propiedad.cultivos && propiedad.cultivos.length > 0" style="grid-column: 1 / -1; margin-top: 0.5rem;">
            <div style="font-weight: bold; margin-bottom: 0.25rem; font-size: 0.85rem;">Cultivos:</div>
            <div *ngFor="let cultivo of propiedad.cultivos" style="font-size: 0.8rem; padding: 0.25rem; background: #f9fafb; border-radius: 4px; margin-bottom: 0.25rem;">
              <strong>{{ cultivo.cultivo_aprovechamiento }}</strong> - {{ (cultivo.superficie_m2 || 0) }} m¬≤ ({{ ((cultivo.superficie_m2 || 0) / 10000).toFixed(4) }} ha)
            </div>
          </div>

          <!-- Valoraciones -->
          <ng-container *ngIf="getValoracion(propiedad.referencia_catastral) as valoracion">
            <div style="grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
              <div style="background: var(--success-bg); padding: 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--success);">üí∞ Valor Calculado</div>
                <div style="font-weight: bold; color: var(--success); font-size: 1.1rem;">{{ formatCurrency(valoracion.valor_estimado_euros) }}</div>
              </div>
              <div *ngIf="propiedad.valor_referencia"
                   style="background: #e0f2fe; padding: 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.75rem; color: #0369a1;">üìä Valor Catastral</div>
                <div style="font-weight: bold; color: #0369a1; font-size: 1.1rem;">{{ formatCurrency(propiedad.valor_referencia) }}</div>
              </div>
              <div *ngIf="!propiedad.valor_referencia"
                   style="background: #f3f4f6; padding: 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.75rem; color: #6b7280;">üìä Valor Catastral</div>
                <div style="font-weight: bold; color: #6b7280;">Sin datos</div>
              </div>
            </div>
            <!-- Diferencia -->
            <div *ngIf="propiedad.valor_referencia as valorOficial"
                 style="grid-column: 1 / -1; text-align: center; font-size: 0.85rem; margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px;"
                 [style.background]="valoracion.valor_estimado_euros >= valorOficial ? '#d1fae5' : '#fee2e2'"
                 [style.color]="valoracion.valor_estimado_euros >= valorOficial ? '#065f46' : '#991b1b'">
              <strong>Diferencia:</strong> {{ valoracion.valor_estimado_euros >= valorOficial ? '+' : '' }}{{ formatCurrency((valoracion.valor_estimado_euros || 0) - valorOficial) }}
              ({{ (((valoracion.valor_estimado_euros || 0) - valorOficial) / valorOficial * 100).toFixed(1) }}%)
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Vista de Tabla Resumen -->
    <div *ngIf="vistaActual === 'resumen'" class="properties-table-container">
      <table class="properties-data-table table-resumen">
        <thead>
          <tr>
            <th>Catastro</th>
            <th>Ref. Catastral</th>
            <th>Municipio</th>
            <th>Partida</th>
            <th>Escritura</th>
            <th>Sup. (m¬≤)</th>
            <th>Sup. (ha)</th>
            <th>‚Ç¨/ha Medio</th>
            <th>Valor Total Calculado ‚Ç¨</th>
            <th>Valor Catastral Oficial ‚Ç¨</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of getPropiedadesResumen()" class="resumen-row">
            <td class="btn-cell">
              <button class="btn-catastro" (click)="abrirCatastro(item.propiedad)" title="Ver en Catastro">
                üîó
              </button>
            </td>
            <td class="ref-catastral">{{ item.referencia_catastral }}</td>
            <td>{{ item.municipio }}</td>
            <td>{{ item.partida }}</td>
            <td class="escritura">{{ item.escritura }}</td>
            <td class="numeric">{{ formatNumber(item.superficie_m2) }}</td>
            <td class="numeric">{{ item.superficie_ha.toFixed(4) }}</td>
            <td class="numeric">{{ formatNumber(item.precio_medio_ha) }}</td>
            <td class="numeric valor-calculado">{{ formatCurrency(item.valor_calculado) }}</td>
            <td class="numeric valor-oficial">{{ formatCurrency(item.valor_oficial) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Mensaje cuando no hay resultados -->
  <section *ngIf="propiedades.length > 0 && propiedadesFiltradas.length === 0 && !cargandoDatos" class="no-results">
    <p>üîç No se encontraron propiedades con los filtros seleccionados</p>
  </section>

  <section *ngIf="propiedades.length === 0 && !cargandoDatos" class="no-results">
    <p>No hay propiedades cargadas</p>
  </section>

</div>

<!-- Modal de Configuraci√≥n -->
<div *ngIf="mostrarConfiguracion" class="modal-overlay" (click)="cerrarConfiguracion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚öôÔ∏è Configuraci√≥n de Valores de Tasaci√≥n</h2>
      <button class="btn-close" (click)="cerrarConfiguracion()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="config-info">
        <p><strong>üìù Nota:</strong> Modifica los valores de tasaci√≥n por hect√°rea para cada tipo de cultivo y municipio.
        Los cambios se guardar√°n localmente y se aplicar√°n autom√°ticamente a todas las valoraciones.</p>
      </div>

      <div *ngIf="valoresEditables" class="config-content">
        <!-- Por cada grupo de municipios -->
        <div *ngFor="let grupo of getMunicipiosPrincipales()" class="municipio-section">
          <h3>{{ grupo.nombre }}</h3>
          <p class="municipio-info">
            <strong>Provincia:</strong> {{ grupo.provincia }} |
            <strong>C√≥digo ATH:</strong> {{ grupo.codigoAth }}
          </p>

          <div class="cultivos-grid">
            <div *ngFor="let codigo of getCodigosCultivo(grupo.municipios[0])" class="cultivo-item">
              <label>
                <strong>{{ codigo }}</strong> - {{ valoresEditables.municipios[grupo.municipios[0]].cultivos[codigo].uso_catastral }}
              </label>
              <div class="input-group">
                <input
                  type="number"
                  [ngModel]="valoresEditables.municipios[grupo.municipios[0]].cultivos[codigo].valor_por_hectarea"
                  (ngModelChange)="actualizarValorCultivo(grupo.municipios, codigo, $event)"
                  min="0"
                  step="100"
                  class="input-valor"
                />
                <span class="input-suffix">‚Ç¨/ha</span>
              </div>
              <small class="cultivo-descripcion">
                {{ valoresEditables.municipios[grupo.municipios[0]].cultivos[codigo].descripcion }}
              </small>
            </div>
          </div>
        </div>

        <!-- Valores por defecto -->
        <div class="municipio-section">
          <h3>Valor por Defecto (cultivos no identificados)</h3>
          <div class="cultivos-grid">
            <div class="cultivo-item">
              <label>
                <strong>{{ valoresEditables.valores_por_defecto.codigo }}</strong> - {{ valoresEditables.valores_por_defecto.uso_catastral }}
              </label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="valoresEditables.valores_por_defecto.valor_por_hectarea"
                  min="0"
                  step="100"
                  class="input-valor"
                />
                <span class="input-suffix">‚Ç¨/ha</span>
              </div>
              <small class="cultivo-descripcion">
                {{ valoresEditables.valores_por_defecto.descripcion }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarConfiguracion()">
        Cancelar
      </button>
      <button class="btn btn-warning" (click)="resetearADefecto()" *ngIf="usandoValoresPersonalizados()">
        üîÑ Resetear a Defecto
      </button>
      <button class="btn btn-primary" (click)="guardarConfiguracion()">
        üíæ Guardar Configuraci√≥n
      </button>
    </div>
  </div>
</div>
