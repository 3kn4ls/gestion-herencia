<!-- Header -->
<header class="app-header">
  <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
    <div>
      <h1>üìã Valoraci√≥n de Propiedades Catastrales</h1>
      <p class="subtitle">
        Sistema de valoraci√≥n basado en cultivos y tasaciones oficiales
        <span *ngIf="usandoValoresPersonalizados()" style="color: #f59e0b; font-weight: bold; margin-left: 1rem;">
          ‚öôÔ∏è Usando valores personalizados
        </span>
      </p>
    </div>
    <div style="display: flex; gap: 10px;">
      <button
        class="btn btn-reparto"
        (click)="abrirReparto()"
        title="Reparto de herencia entre herederos"
        *ngIf="!mostrarReparto && propiedades.length > 0"
      >
        ‚öñÔ∏è Reparto Herencia
      </button>
      <button
        class="btn btn-config"
        (click)="abrirConfiguracion()"
        title="Configurar valores de tasaci√≥n"
      >
        ‚öôÔ∏è Configuraci√≥n
      </button>
    </div>
  </div>
</header>

<div class="container">

  <!-- Loading indicator -->
  <div *ngIf="cargandoDatos" class="loading">
    <div class="spinner"></div>
    <p>Cargando datos catastrales y calculando valoraciones...</p>
  </div>

  <!-- Resumen general -->
  <section *ngIf="propiedades.length > 0 && !cargandoDatos" class="summary-section">
    <h2>Resumen General</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ propiedades.length }}</div>
        <div class="stat-label">Propiedades Totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCurrency(resultadoValoracion?.valor_total_estimado || 0) }}</div>
        <div class="stat-label">Valor Total Calculado</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ opcionesMunicipio.length }}</div>
        <div class="stat-label">Municipios</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ opcionesProvincia.length }}</div>
        <div class="stat-label">Provincias</div>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section *ngIf="propiedades.length > 0 && !cargandoDatos" class="filters-section">
    <h2>Filtros</h2>
    <div class="filters-grid">
      <div class="filter-item">
        <label for="filterClase">Clase</label>
        <select
          id="filterClase"
          class="filter-select"
          [(ngModel)]="filtros.clase"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let clase of opcionesClase" [value]="clase">{{ clase }}</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterProvincia">Provincia</label>
        <select
          id="filterProvincia"
          class="filter-select"
          [(ngModel)]="filtros.provincia"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let provincia of opcionesProvincia" [value]="provincia">{{ provincia }}</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterMunicipio">Municipio</label>
        <select
          id="filterMunicipio"
          class="filter-select"
          [(ngModel)]="filtros.municipio"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let municipio of opcionesMunicipio" [value]="municipio">{{ municipio }}</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterUso">Uso Principal</label>
        <select
          id="filterUso"
          class="filter-select"
          [(ngModel)]="filtros.uso"
          (change)="aplicarFiltros()"
        >
          <option value="all">Todos</option>
          <option *ngFor="let uso of opcionesUso" [value]="uso">{{ uso }}</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Buscador -->
  <section *ngIf="propiedades.length > 0 && !cargandoDatos" class="search-section">
    <h2>Buscar</h2>
    <input
      type="text"
      id="searchInput"
      [(ngModel)]="filtros.busqueda"
      (input)="aplicarFiltros()"
      placeholder="Buscar por referencia catastral, partida, municipio..."
    >
    <p class="help-text">
      Mostrando {{ propiedadesFiltradas.length }} de {{ propiedades.length }} propiedades
    </p>
  </section>

  <!-- Lista de propiedades -->
  <section *ngIf="propiedadesFiltradas.length > 0 && !cargandoDatos" class="properties-section">
    <div class="properties-header">
      <h2>Propiedades y Valoraciones</h2>
      <div class="properties-controls">
        <!-- Toggle vista -->
        <div class="view-toggle">
          <button
            class="btn-vista"
            [class.active]="vistaActual === 'tabla'"
            (click)="cambiarVista('tabla')"
          >
            üìä Tabla Detalle
          </button>
          <button
            class="btn-vista"
            [class.active]="vistaActual === 'resumen'"
            (click)="cambiarVista('resumen')"
          >
            üìã Tabla Resumen
          </button>
          <button
            class="btn-vista"
            [class.active]="vistaActual === 'tarjetas'"
            (click)="cambiarVista('tarjetas')"
          >
            üóÇÔ∏è Tarjetas
          </button>
        </div>
        <!-- Bot√≥n exportar -->
        <button
          class="btn btn-sec"
          style="background: #059669; color: white;"
          (click)="exportarAExcel()"
        >
          üìã Copiar para Excel
        </button>
        <!-- Bot√≥n crear propiedad -->
        <button
          class="btn btn-primary"
          style="background: #2563eb; color: white;"
          (click)="crearNuevaPropiedad()"
          title="Crear nueva propiedad"
        >
          ‚ûï Nueva Propiedad
        </button>
      </div>
    </div>

    <!-- Vista de Tabla -->
    <div *ngIf="vistaActual === 'tabla'" class="properties-table-container">
      <table class="properties-data-table">
        <thead>
          <tr>
            <th>Acciones</th>
            <th>Catastro</th>
            <th>Ref. Catastral</th>
            <th>Provincia</th>
            <th>Municipio</th>
            <th>Partida</th>
            <th>Pol√≠gono</th>
            <th>Parcela</th>
            <th>Clase</th>
            <th>Uso</th>
            <th>Escritura</th>
            <th>Grupo</th>
            <th>‚úì Valid.</th>
            <th title="Coef. Aptitud Producci√≥n">FA</th>
            <th title="Coef. Superficie Excesiva">CS</th>
            <th title="Coef. Localizaci√≥n">FLS</th>
            <th title="Coef. Concentraci√≥n Parcelaria">CP</th>
            <th title="Coef. Depreciaci√≥n Econ√≥mica">DE</th>
            <th>Subparcela</th>
            <th>Cultivo/Aprovechamiento</th>
            <th>C√≥digo</th>
            <th>Sup. (m¬≤)</th>
            <th>Sup. (ha)</th>
            <th>‚Ç¨/ha</th>
            <th>Valor ‚Ç¨</th>
            <th>Valor Total Calculado ‚Ç¨</th>
            <th>Valor Catastral Oficial ‚Ç¨</th>
            <th>Diferencia ‚Ç¨</th>
            <th>Diferencia %</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let propiedad of propiedadesFiltradas">
            <ng-container *ngIf="propiedad.cultivos && propiedad.cultivos.length > 0; else sinCultivos">
              <tr
                *ngFor="let cultivo of propiedad.cultivos; let i = index"
                [class.first-row]="i === 0"
                [class.subparcela-row]="i > 0"
              >
                <td *ngIf="i === 0" [attr.rowspan]="propiedad.cultivos!.length" class="actions-cell">
                  <button class="btn-action btn-edit" (click)="editarPropiedad(propiedad)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn-action btn-delete" (click)="eliminarPropiedad(propiedad)" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </td>
                <td *ngIf="i === 0" [attr.rowspan]="propiedad.cultivos!.length" class="btn-cell">
                  <button class="btn-catastro" (click)="abrirCatastro(propiedad)" title="Ver en Catastro">
                    üîó
                  </button>
                </td>
                <td class="ref-catastral">{{ propiedad.referencia_catastral }}</td>
                <td>{{ propiedad.localizacion?.provincia }}</td>
                <td>{{ propiedad.localizacion?.municipio }}</td>
                <td>{{ propiedad.localizacion?.partida }}</td>
                <td>{{ propiedad.localizacion?.poligono }}</td>
                <td>{{ propiedad.localizacion?.parcela }}</td>
                <td>{{ propiedad.datos_inmueble?.clase }}</td>
                <td>{{ propiedad.datos_inmueble?.uso_principal }}</td>
                <td class="escritura">{{ propiedad.escritura }}</td>
                <td class="cod-grupo">
                  <span *ngIf="propiedad.codGrupo" class="badge-grupo-table">{{ propiedad.codGrupo }}</span>
                </td>
                <td class="precio-validado">
                  <span *ngIf="propiedad.precioValidado" class="check-validado">‚úì</span>
                </td>
                <td class="coef-cell">{{ propiedad.coefFA ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefCS ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefFLS ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefCP ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefDE ?? '-' }}</td>
                <td>{{ cultivo.subparcela }}</td>
                <td class="cultivo">{{ cultivo.cultivo_aprovechamiento }}</td>
                <ng-container *ngIf="getValoracion(propiedad.referencia_catastral) as valoracion">
                  <ng-container *ngIf="valoracion.detalles_cultivos && valoracion.detalles_cultivos[i] as detalle">
                    <td class="codigo">{{ detalle.codigo_catastral }}</td>
                    <td class="numeric">{{ cultivo.superficie_m2 }}</td>
                    <td class="numeric">{{ detalle.superficie_ha.toFixed(4) }}</td>
                    <td class="numeric">{{ formatNumber(detalle.precio_ha) }}</td>
                    <td class="numeric">{{ formatCurrency(detalle.valor_estimado) }}</td>
                  </ng-container>
                  <ng-container *ngIf="!valoracion.detalles_cultivos || !valoracion.detalles_cultivos[i]">
                    <td></td><td></td><td></td><td></td><td></td>
                  </ng-container>
                  <ng-container *ngIf="i === 0">
                    <td class="numeric valor-calculado">{{ formatCurrency(valoracion.valor_estimado_euros) }}</td>
                    <td class="numeric valor-oficial">{{ formatCurrency(propiedad.valor_referencia) }}</td>
                    <ng-container *ngIf="propiedad.valor_referencia as valorOficial">
                      <td class="numeric"
                          [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                          [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                        {{ formatCurrency((valoracion.valor_estimado_euros || 0) - valorOficial) }}
                      </td>
                      <td class="numeric"
                          [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                          [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                        {{ (((valoracion.valor_estimado_euros || 0) - valorOficial) / valorOficial * 100).toFixed(2) }}%
                      </td>
                    </ng-container>
                    <ng-container *ngIf="!propiedad.valor_referencia">
                      <td class="numeric">-</td><td class="numeric">-</td>
                    </ng-container>
                  </ng-container>
                  <ng-container *ngIf="i > 0">
                    <td></td><td></td><td></td><td></td>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!getValoracion(propiedad.referencia_catastral)">
                  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </ng-container>
              </tr>
            </ng-container>
            <ng-template #sinCultivos>
              <tr class="first-row">
                <td class="actions-cell">
                  <button class="btn-action btn-edit" (click)="editarPropiedad(propiedad)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn-action btn-delete" (click)="eliminarPropiedad(propiedad)" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </td>
                <td class="btn-cell">
                  <button class="btn-catastro" (click)="abrirCatastro(propiedad)" title="Ver en Catastro">
                    üîó
                  </button>
                </td>
                <td class="ref-catastral">{{ propiedad.referencia_catastral }}</td>
                <td>{{ propiedad.localizacion?.provincia }}</td>
                <td>{{ propiedad.localizacion?.municipio }}</td>
                <td>{{ propiedad.localizacion?.partida }}</td>
                <td>{{ propiedad.localizacion?.poligono }}</td>
                <td>{{ propiedad.localizacion?.parcela }}</td>
                <td>{{ propiedad.datos_inmueble?.clase }}</td>
                <td>{{ propiedad.datos_inmueble?.uso_principal }}</td>
                <td class="escritura">{{ propiedad.escritura }}</td>
                <td class="cod-grupo">
                  <span *ngIf="propiedad.codGrupo" class="badge-grupo-table">{{ propiedad.codGrupo }}</span>
                </td>
                <td class="precio-validado">
                  <span *ngIf="propiedad.precioValidado" class="check-validado">‚úì</span>
                </td>
                <td class="coef-cell">{{ propiedad.coefFA ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefCS ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefFLS ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefCP ?? '-' }}</td>
                <td class="coef-cell">{{ propiedad.coefDE ?? '-' }}</td>
                <td></td><td></td><td></td><td></td><td></td><td></td>
                <ng-container *ngIf="getValoracion(propiedad.referencia_catastral) as valoracion">
                  <td class="numeric valor-calculado">{{ formatCurrency(valoracion.valor_estimado_euros) }}</td>
                  <td class="numeric valor-oficial">{{ formatCurrency(propiedad.valor_referencia) }}</td>
                  <ng-container *ngIf="propiedad.valor_referencia as valorOficial">
                    <td class="numeric"
                        [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                        [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                      {{ formatCurrency((valoracion.valor_estimado_euros || 0) - valorOficial) }}
                    </td>
                    <td class="numeric"
                        [class.positivo]="valoracion.valor_estimado_euros > valorOficial"
                        [class.negativo]="valoracion.valor_estimado_euros < valorOficial">
                      {{ (((valoracion.valor_estimado_euros || 0) - valorOficial) / valorOficial * 100).toFixed(2) }}%
                    </td>
                  </ng-container>
                  <ng-container *ngIf="!propiedad.valor_referencia">
                    <td class="numeric">-</td><td class="numeric">-</td>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!getValoracion(propiedad.referencia_catastral)">
                  <td></td><td></td><td></td><td></td>
                </ng-container>
              </tr>
            </ng-template>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Vista de Tarjetas -->
    <div *ngIf="vistaActual === 'tarjetas'" class="properties-list">
      <div
        *ngFor="let propiedad of propiedadesFiltradas"
        class="property-card"
      >
        <div class="property-header">
          <div>
            <div class="property-ref">{{ propiedad.referencia_catastral }}</div>
            <div class="property-location">
              {{ propiedad.localizacion?.partida }} -
              {{ propiedad.localizacion?.municipio }}
              ({{ propiedad.localizacion?.provincia }})
            </div>
            <div *ngIf="propiedad.escritura" class="property-escritura">
              {{ propiedad.escritura }}
            </div>
          </div>
          <button class="btn-catastro-card" (click)="abrirCatastro(propiedad)" title="Ver en Catastro">
            üîó Catastro
          </button>
        </div>
        <div class="property-details">
          <div class="detail-item">
            <span class="detail-label">Clase</span>
            <span class="detail-value">{{ propiedad.datos_inmueble?.clase || 'N/A' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Uso</span>
            <span class="detail-value">{{ propiedad.datos_inmueble?.uso_principal || 'N/A' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Pol√≠gono/Parcela</span>
            <span class="detail-value">{{ propiedad.localizacion?.poligono }}/{{ propiedad.localizacion?.parcela }}</span>
          </div>
          <div class="detail-item" *ngIf="propiedad.m2Escritura">
            <span class="detail-label">m¬≤ Escritura</span>
            <span class="detail-value">{{ formatNumber(propiedad.m2Escritura) }} m¬≤</span>
          </div>

          <!-- Cultivos -->
          <div *ngIf="propiedad.cultivos && propiedad.cultivos.length > 0" style="grid-column: 1 / -1; margin-top: 0.5rem;">
            <div style="font-weight: bold; margin-bottom: 0.25rem; font-size: 0.85rem;">Cultivos:</div>
            <div *ngFor="let cultivo of propiedad.cultivos" style="font-size: 0.8rem; padding: 0.25rem; background: #f9fafb; border-radius: 4px; margin-bottom: 0.25rem;">
              <strong>{{ cultivo.cultivo_aprovechamiento }}</strong> - {{ (cultivo.superficie_m2 || 0) }} m¬≤ ({{ ((cultivo.superficie_m2 || 0) / 10000).toFixed(4) }} ha)
            </div>
          </div>

          <!-- Valoraciones -->
          <ng-container *ngIf="getValoracion(propiedad.referencia_catastral) as valoracion">
            <div style="grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
              <div style="background: var(--success-bg); padding: 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--success);">üí∞ Valor Calculado</div>
                <div style="font-weight: bold; color: var(--success); font-size: 1.1rem;">{{ formatCurrency(valoracion.valor_estimado_euros) }}</div>
              </div>
              <div *ngIf="propiedad.valor_referencia"
                   style="background: #e0f2fe; padding: 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.75rem; color: #0369a1;">üìä Valor Catastral</div>
                <div style="font-weight: bold; color: #0369a1; font-size: 1.1rem;">{{ formatCurrency(propiedad.valor_referencia) }}</div>
              </div>
              <div *ngIf="!propiedad.valor_referencia"
                   style="background: #f3f4f6; padding: 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.75rem; color: #6b7280;">üìä Valor Catastral</div>
                <div style="font-weight: bold; color: #6b7280;">Sin datos</div>
              </div>
            </div>
            <!-- Precio Manual -->
            <div *ngIf="propiedad.precioManual"
                 style="grid-column: 1 / -1; text-align: center; font-size: 0.85rem; margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; background: #fef3c7; color: #92400e;">
              <strong>üíµ Precio Manual:</strong> {{ formatCurrency(propiedad.precioManual) }}
            </div>
            <div *ngIf="!propiedad.precioManual"
                 style="grid-column: 1 / -1; text-align: center; font-size: 0.85rem; margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; background: #f3f4f6; color: #6b7280;">
              <strong>üíµ Precio Manual:</strong> Sin definir
            </div>
          </ng-container>
          <!-- Bot√≥n Editar -->
          <div style="grid-column: 1 / -1; margin-top: 0.75rem; text-align: center;">
            <button class="btn-editar-card" (click)="editarPropiedad(propiedad)" title="Editar propiedad">
              ‚úèÔ∏è Editar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Vista de Tabla Resumen -->
    <div *ngIf="vistaActual === 'resumen'" class="properties-table-container">
      <table class="properties-data-table table-resumen">
        <thead>
          <tr>
            <th>Acciones</th>
            <th>Ref. Catastral</th>
            <th>Municipio</th>
            <th>Partida</th>
            <th>Escritura</th>
            <th>m¬≤ Escrit.</th>
            <th>Grupo</th>
            <th>‚úì Valid.</th>
            <th>Sup. (m¬≤)</th>
            <th>Sup. (ha)</th>
            <th>‚Ç¨/ha Medio</th>
            <th>Valor Calculado ‚Ç¨</th>
            <th>Valor Catastral ‚Ç¨</th>
            <th>Precio Manual ‚Ç¨</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of getPropiedadesResumen()" class="resumen-row">
            <td class="btn-cell acciones-cell">
              <button class="btn-catastro" (click)="abrirCatastro(item.propiedad)" title="Ver en Catastro">
                üîó
              </button>
              <button class="btn-editar-tabla" (click)="editarPropiedad(item.propiedad)" title="Editar propiedad">
                ‚úèÔ∏è
              </button>
            </td>
            <td class="ref-catastral">{{ item.referencia_catastral }}</td>
            <td>{{ item.municipio }}</td>
            <td>{{ item.partida }}</td>
            <td class="escritura">{{ item.escritura }}</td>
            <td class="numeric">{{ item.m2Escritura ? formatNumber(item.m2Escritura) : '-' }}</td>
            <td class="cod-grupo">
              <span *ngIf="item.codGrupo" class="badge-grupo-table">{{ item.codGrupo }}</span>
            </td>
            <td class="precio-validado">
              <span *ngIf="item.precioValidado" class="check-validado">‚úì</span>
            </td>
            <td class="numeric">{{ formatNumber(item.superficie_m2) }}</td>
            <td class="numeric">{{ item.superficie_ha.toFixed(4) }}</td>
            <td class="numeric">{{ formatNumber(item.precio_medio_ha) }}</td>
            <td class="numeric valor-calculado">{{ formatCurrency(item.valor_calculado) }}</td>
            <td class="numeric valor-oficial">{{ formatCurrency(item.valor_oficial) }}</td>
            <td class="numeric precio-manual" [class.tiene-precio-manual]="item.precioManual">
              {{ item.precioManual ? formatCurrency(item.precioManual) : '-' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Mensaje cuando no hay resultados -->
  <section *ngIf="propiedades.length > 0 && propiedadesFiltradas.length === 0 && !cargandoDatos" class="no-results">
    <p>üîç No se encontraron propiedades con los filtros seleccionados</p>
  </section>

  <section *ngIf="propiedades.length === 0 && !cargandoDatos" class="no-results">
    <p>No hay propiedades cargadas</p>
  </section>

</div>

<!-- Modal de Configuraci√≥n -->
<div *ngIf="mostrarConfiguracion" class="modal-overlay" (click)="cerrarConfiguracion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚öôÔ∏è Configuraci√≥n de Valores de Tasaci√≥n</h2>
      <button class="btn-close" (click)="cerrarConfiguracion()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="config-info">
        <p><strong>üìù Nota:</strong> Modifica los valores de tasaci√≥n por hect√°rea para cada tipo de cultivo y municipio.
        Los cambios se guardar√°n localmente y se aplicar√°n autom√°ticamente a todas las valoraciones.</p>
      </div>

      <div *ngIf="valoresEditables" class="config-content">
        <!-- Por cada grupo de municipios -->
        <div *ngFor="let grupo of municipiosPrincipales" class="municipio-section">
          <h3>{{ grupo.nombre }}</h3>
          <p class="municipio-info">
            <strong>Provincia:</strong> {{ grupo.provincia }} |
            <strong>C√≥digo ATH:</strong> {{ grupo.codigoAth }}
          </p>

          <div class="cultivos-grid">
            <div *ngFor="let codigo of getCodigosCultivo(grupo.municipios[0])" class="cultivo-item">
              <label>
                <strong>{{ codigo }}</strong> - {{ valoresEditables.municipios[grupo.municipios[0]].cultivos[codigo].uso_catastral }}
              </label>
              <div class="input-group">
                <input
                  type="number"
                  [ngModel]="valoresEditables.municipios[grupo.municipios[0]].cultivos[codigo].valor_por_hectarea"
                  (ngModelChange)="actualizarValorCultivo(grupo.municipios, codigo, $event)"
                  min="0"
                  step="100"
                  class="input-valor"
                />
                <span class="input-suffix">‚Ç¨/ha</span>
              </div>
              <small class="cultivo-descripcion">
                {{ valoresEditables.municipios[grupo.municipios[0]].cultivos[codigo].descripcion }}
              </small>
            </div>
          </div>
        </div>

        <!-- Valores por defecto -->
        <div class="municipio-section">
          <h3>Valor por Defecto (cultivos no identificados)</h3>
          <div class="cultivos-grid">
            <div class="cultivo-item">
              <label>
                <strong>{{ valoresEditables.valores_por_defecto.codigo }}</strong> - {{ valoresEditables.valores_por_defecto.uso_catastral }}
              </label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="valoresEditables.valores_por_defecto.valor_por_hectarea"
                  min="0"
                  step="100"
                  class="input-valor"
                />
                <span class="input-suffix">‚Ç¨/ha</span>
              </div>
              <small class="cultivo-descripcion">
                {{ valoresEditables.valores_por_defecto.descripcion }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarConfiguracion()">
        Cancelar
      </button>
      <button class="btn btn-warning" (click)="resetearADefecto()" *ngIf="usandoValoresPersonalizados()">
        üîÑ Resetear a Defecto
      </button>
      <button class="btn btn-primary" (click)="guardarConfiguracion()">
        üíæ Guardar Configuraci√≥n
      </button>
    </div>
  </div>
</div>

<!-- Modal CRUD de Propiedad -->
<div *ngIf="mostrarModalPropiedad" class="modal-overlay" (click)="cerrarModalPropiedad()">
  <div class="modal-content modal-propiedad" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modoEdicion === 'crear' ? '‚ûï Nueva Propiedad' : '‚úèÔ∏è Editar Propiedad' }}</h2>
      <button class="btn-close" (click)="cerrarModalPropiedad()">‚úï</button>
    </div>

    <div class="modal-body" *ngIf="propiedadEditando">
      <form class="form-propiedad">
        <!-- Secci√≥n: Datos B√°sicos -->
        <div class="form-section">
          <h3 class="section-title">üìã Datos B√°sicos</h3>

          <!-- Mostrar ID de MongoDB en modo edici√≥n -->
          <div *ngIf="modoEdicion === 'editar' && propiedadEditando" class="info-id">
            <small>
              <strong>ID MongoDB:</strong>
              <code>{{ propiedadEditando['_id'] ? 'Presente ‚úì' : 'No encontrado ‚úó' }}</code>
              <span *ngIf="propiedadEditando['_id']" style="color: #64748b; margin-left: 8px;">
                ({{ propiedadEditando['_id'] }})
              </span>
            </small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="referencia">Referencia Catastral *</label>
              <input
                type="text"
                id="referencia"
                [(ngModel)]="propiedadEditando.referencia_catastral"
                name="referencia"
                class="form-control"
                [readonly]="modoEdicion === 'editar'"
                required>
            </div>
            <div class="form-group">
              <label for="escritura">Escritura</label>
              <input
                type="text"
                id="escritura"
                [(ngModel)]="propiedadEditando.escritura"
                name="escritura"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="m2Escritura">m2 Escritura</label>
              <input
                type="number"
                id="m2Escritura"
                [(ngModel)]="propiedadEditando.m2Escritura"
                name="m2Escritura"
                class="form-control"
                step="0.01"
                min="0"
                placeholder="Superficie de la escritura">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="descripcion">Descripci√≥n de la Parcela</label>
              <textarea
                id="descripcion"
                [(ngModel)]="propiedadEditando.desc"
                name="descripcion"
                class="form-control"
                rows="3"
                placeholder="Descripci√≥n detallada de la parcela..."></textarea>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Localizaci√≥n -->
        <div class="form-section">
          <h3 class="section-title">üìç Localizaci√≥n</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="provincia">Provincia</label>
              <input
                type="text"
                id="provincia"
                [(ngModel)]="propiedadEditando.localizacion!.provincia"
                name="provincia"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="municipio">Municipio</label>
              <input
                type="text"
                id="municipio"
                [(ngModel)]="propiedadEditando.localizacion!.municipio"
                name="municipio"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="partida">Partida</label>
              <input
                type="text"
                id="partida"
                [(ngModel)]="propiedadEditando.localizacion!.partida"
                name="partida"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="poligono">Pol√≠gono</label>
              <input
                type="text"
                id="poligono"
                [(ngModel)]="propiedadEditando.localizacion!.poligono"
                name="poligono"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="parcela">Parcela</label>
              <input
                type="text"
                id="parcela"
                [(ngModel)]="propiedadEditando.localizacion!.parcela"
                name="parcela"
                class="form-control">
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Datos del Inmueble -->
        <div class="form-section">
          <h3 class="section-title">üè† Datos del Inmueble</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="clase">Clase</label>
              <input
                type="text"
                id="clase"
                [(ngModel)]="propiedadEditando.datos_inmueble!.clase"
                name="clase"
                class="form-control"
                placeholder="Ej: R√∫stico, Urbano">
            </div>
            <div class="form-group">
              <label for="uso">Uso Principal</label>
              <input
                type="text"
                id="uso"
                [(ngModel)]="propiedadEditando.datos_inmueble!.uso_principal"
                name="uso"
                class="form-control">
            </div>
            <div class="form-group">
              <label for="superficie">Superficie Construida (m¬≤)</label>
              <input
                type="number"
                id="superficie"
                [(ngModel)]="propiedadEditando.datos_inmueble!.superficie_construida"
                name="superficie"
                class="form-control"
                step="0.01">
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Valoraci√≥n -->
        <div class="form-section">
          <h3 class="section-title">üí∂ Valoraci√≥n</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="valorRef">Valor Catastral Oficial (‚Ç¨)</label>
              <input
                type="number"
                id="valorRef"
                [(ngModel)]="propiedadEditando.valor_referencia"
                name="valorRef"
                class="form-control"
                step="0.01">
            </div>
            <div class="form-group">
              <label for="precioManual">
                Precio Manual (‚Ç¨)
                <span class="label-hint">Para herencias</span>
              </label>
              <input
                type="number"
                id="precioManual"
                [(ngModel)]="propiedadEditando.precioManual"
                name="precioManual"
                class="form-control"
                step="0.01"
                placeholder="Opcional - Sobreescribe el calculado">
              <small class="help-text">
                Si se especifica, este valor se usar√° en el reparto de herencias en lugar del calculado
              </small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="precioValidado"
                  [(ngModel)]="propiedadEditando.precioValidado"
                  name="precioValidado"
                  class="form-checkbox">
                <span class="checkbox-text">‚úì Precio validado</span>
              </label>
              <small class="help-text">
                Marca si el precio de esta propiedad ha sido verificado y validado
              </small>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Informaci√≥n Adicional -->
        <div class="form-section">
          <h3 class="section-title">üåä Informaci√≥n Adicional</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="distanciaMar">Distancia al Mar (metros)</label>
              <input
                type="number"
                id="distanciaMar"
                [(ngModel)]="propiedadEditando.distanciaMar"
                name="distanciaMar"
                class="form-control"
                step="1"
                min="0"
                placeholder="Distancia en metros">
            </div>
            <div class="form-group">
              <label for="codGrupo">
                C√≥digo de Grupo
                <span class="label-hint">Para reparto autom√°tico</span>
              </label>
              <input
                type="text"
                id="codGrupo"
                [(ngModel)]="propiedadEditando.codGrupo"
                name="codGrupo"
                class="form-control"
                placeholder="Ej: GRUPO_A"
                maxlength="20">
              <small class="help-text">
                Propiedades con el mismo c√≥digo se agrupar√°n en el reparto autom√°tico
              </small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="ignorarReparto"
                  [(ngModel)]="propiedadEditando.ignorarReparto"
                  name="ignorarReparto"
                  class="form-checkbox">
                <span class="checkbox-text">Ignorar en reparto autom√°tico</span>
              </label>
              <small class="help-text">
                Si est√° marcado, esta propiedad no se incluir√° en el reparto autom√°tico de herencias
              </small>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Coeficientes Agron√≥micos (solo para r√∫sticos) -->
        <div class="form-section">
          <h3 class="section-title">üåø Coeficientes Agron√≥micos</h3>
          <p class="section-hint">Coeficientes para ajustar la valoraci√≥n de fincas r√∫sticas. Si no se especifican, se usan valores de 1.</p>
          <div class="form-row">
            <div class="form-group">
              <label for="coefFA">
                FA - Aptitud Producci√≥n
                <span class="label-hint">Factor productivo</span>
              </label>
              <input
                type="number"
                id="coefFA"
                [(ngModel)]="propiedadEditando.coefFA"
                name="coefFA"
                class="form-control"
                step="0.01"
                min="0"
                max="2"
                placeholder="1.0">
            </div>
            <div class="form-group">
              <label for="coefCS">
                CS - Superficie Excesiva
                <span class="label-hint">Factor tama√±o</span>
              </label>
              <input
                type="number"
                id="coefCS"
                [(ngModel)]="propiedadEditando.coefCS"
                name="coefCS"
                class="form-control"
                step="0.01"
                min="0"
                max="2"
                placeholder="1.0">
            </div>
            <div class="form-group">
              <label for="coefFLS">
                FLS - Localizaci√≥n
                <span class="label-hint">Factor socioecon√≥mico</span>
              </label>
              <input
                type="number"
                id="coefFLS"
                [(ngModel)]="propiedadEditando.coefFLS"
                name="coefFLS"
                class="form-control"
                step="0.01"
                min="0"
                max="2"
                placeholder="1.0">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="coefCP">
                CP - Concentraci√≥n Parcelaria
                <span class="label-hint">Factor agrupaci√≥n</span>
              </label>
              <input
                type="number"
                id="coefCP"
                [(ngModel)]="propiedadEditando.coefCP"
                name="coefCP"
                class="form-control"
                step="0.01"
                min="0"
                max="2"
                placeholder="1.0">
            </div>
            <div class="form-group">
              <label for="coefDE">
                DE - Depreciaci√≥n Econ√≥mica
                <span class="label-hint">Factor depreciaci√≥n</span>
              </label>
              <input
                type="number"
                id="coefDE"
                [(ngModel)]="propiedadEditando.coefDE"
                name="coefDE"
                class="form-control"
                step="0.01"
                min="0"
                max="2"
                placeholder="1.0">
            </div>
            <div class="form-group coef-info">
              <label>F√≥rmula</label>
              <div class="formula-display">
                Vs/Ha = MV √ó FA √ó CS √ó FLS √ó CP √ó DE
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Cultivos -->
        <div class="form-section">
          <h3 class="section-title">
            üåæ Cultivos
            <button
              type="button"
              class="btn btn-sm btn-success"
              (click)="anadirCultivo()"
              style="margin-left: auto;">
              ‚ûï Anadir Cultivo
            </button>
          </h3>

          <div *ngIf="propiedadEditando.cultivos && propiedadEditando.cultivos.length > 0" class="cultivos-list">
            <div *ngFor="let cultivo of propiedadEditando.cultivos; let i = index" class="cultivo-item">
              <div class="cultivo-header">
                <span class="cultivo-number">Cultivo #{{ i + 1 }}</span>
                <button
                  type="button"
                  class="btn-delete-cultivo"
                  (click)="eliminarCultivo(i)"
                  title="Eliminar cultivo">
                  üóëÔ∏è
                </button>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Subparcela</label>
                  <input
                    type="text"
                    [(ngModel)]="cultivo.subparcela"
                    [name]="'subparcela_' + i"
                    class="form-control form-control-sm">
                </div>
                <div class="form-group">
                  <label>Cultivo/Aprovechamiento</label>
                  <input
                    type="text"
                    [(ngModel)]="cultivo.cultivo_aprovechamiento"
                    [name]="'cultivo_' + i"
                    class="form-control form-control-sm">
                </div>
                <div class="form-group">
                  <label>Intensidad Productiva</label>
                  <input
                    type="text"
                    [(ngModel)]="cultivo.intensidad_productiva"
                    [name]="'intensidad_' + i"
                    class="form-control form-control-sm">
                </div>
                <div class="form-group">
                  <label>Superficie (m¬≤)</label>
                  <input
                    type="number"
                    [(ngModel)]="cultivo.superficie_m2"
                    [name]="'superficie_m2_' + i"
                    class="form-control form-control-sm"
                    step="0.01">
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!propiedadEditando.cultivos || propiedadEditando.cultivos.length === 0" class="no-cultivos">
            <p>No hay cultivos definidos. Haz clic en "Anadir Cultivo" para agregar uno.</p>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalPropiedad()">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="guardarPropiedad()">
        {{ modoEdicion === 'crear' ? '‚ûï Crear' : 'üíæ Guardar' }}
      </button>
    </div>
  </div>
</div>

<!-- M√≥dulo de Reparto de Herencia -->
<div *ngIf="mostrarReparto" class="modal-reparto">
  <div class="modal-reparto-contenido">
    <button class="btn-cerrar-reparto" (click)="cerrarReparto()" title="Cerrar reparto">‚úï</button>
    <app-reparto-herencia
      [propiedades]="propiedades"
      [valoraciones]="resultadoValoracion?.valoraciones || []">
    </app-reparto-herencia>
  </div>
</div>
