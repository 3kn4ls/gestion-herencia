<!-- Modal de ConfiguraciÃ³n -->
<div class="modal-configuracion" *ngIf="mostrarConfiguracion">
  <div class="modal-contenido">
    <h2>âš–ï¸ Configurar Reparto de Herencia</h2>

    <div class="formulario">
      <div class="campo">
        <label for="numeroHerederos">NÃºmero de herederos:</label>
        <input
          type="number"
          id="numeroHerederos"
          [(ngModel)]="config.numeroHerederos"
          min="1"
          max="10"
          class="input-numero">
        <small>Entre 1 y 10 herederos</small>
      </div>

      <div class="campo">
        <label for="criterioBalance">Criterio de balanceo:</label>
        <select id="criterioBalance" [(ngModel)]="config.criterioBalance" class="select">
          <option value="valor">Solo valor econÃ³mico</option>
          <option value="mixto">Mixto (valor + tipo de propiedad)</option>
        </select>
        <small>
          <span *ngIf="config.criterioBalance === 'valor'">
            Las propiedades se distribuyen solo por su valor econÃ³mico
          </span>
          <span *ngIf="config.criterioBalance === 'mixto'">
            Se intenta equilibrar tanto el valor como el tipo de propiedades (rÃºsticas/urbanas)
          </span>
        </small>
      </div>

      <div class="campo">
        <label for="desequilibrio">Desequilibrio mÃ¡ximo permitido:</label>
        <input
          type="number"
          id="desequilibrio"
          [(ngModel)]="config.porcentajeDesequilibrioMaximo"
          min="0"
          max="50"
          class="input-numero">
        <small>Porcentaje mÃ¡ximo de diferencia entre herederos (recomendado: 10%)</small>
      </div>

      <div class="botones-modal">
        <button (click)="iniciarReparto()" class="btn btn-primary btn-grande">
          ğŸš€ Iniciar Reparto
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Vista Principal de Reparto -->
<div class="contenedor-reparto" *ngIf="!mostrarConfiguracion">

  <!-- Barra de herramientas -->
  <div class="barra-herramientas">
    <div class="titulo-seccion">
      <h2>âš–ï¸ Reparto de Herencia</h2>
      <span class="badge">{{ herederos.length }} herederos</span>
    </div>

    <div class="botones-accion">
      <button (click)="abrirModalGuardar()" class="btn btn-primary" title="Guardar reparto en el servidor">
        ğŸ’¾ Guardar
      </button>
      <button (click)="abrirModalCargar()" class="btn btn-primary" title="Cargar reparto guardado">
        ğŸ“‚ Cargar
      </button>
      <button (click)="repartirAutomaticamente()" class="btn btn-success" title="Reparto automÃ¡tico balanceado">
        ğŸ¤– Reparto AutomÃ¡tico
      </button>
      <button (click)="resetearReparto()" class="btn btn-warning" title="Volver todas las propiedades a disponibles">
        ğŸ”„ Resetear
      </button>
      <button (click)="exportarReparto()" class="btn btn-info" title="Exportar reparto a texto">
        ğŸ“„ Exportar Texto
      </button>
      <button (click)="exportarPDF()" class="btn btn-pdf" title="Generar informe PDF profesional">
        ğŸ“‘ Generar PDF
      </button>
      <button (click)="volverAConfiguracion()" class="btn btn-secondary" title="Cambiar configuraciÃ³n">
        âš™ï¸ Configurar
      </button>
    </div>
  </div>

  <!-- EstadÃ­sticas Generales -->
  <div class="estadisticas-generales" *ngIf="estadisticas">
    <div class="card-estadistica">
      <div class="stat-label">Valor Total</div>
      <div class="stat-value">{{ formatCurrency(estadisticas.valorTotal) }}</div>
    </div>

    <div class="card-estadistica">
      <div class="stat-label">Promedio por Heredero</div>
      <div class="stat-value">{{ formatCurrency(estadisticas.valorPromedioPorHeredero) }}</div>
    </div>

    <div class="card-estadistica">
      <div class="stat-label">Diferencia MÃ¡x-MÃ­n</div>
      <div class="stat-value">{{ formatCurrency(estadisticas.diferenciaMaxMin) }}</div>
    </div>

    <div class="card-estadistica" [class.equilibrado]="estadisticas.equilibrado" [class.desequilibrado]="!estadisticas.equilibrado">
      <div class="stat-label">Estado</div>
      <div class="stat-value">
        <span *ngIf="estadisticas.equilibrado">âœ… Equilibrado</span>
        <span *ngIf="!estadisticas.equilibrado">âš ï¸ Desequilibrado</span>
      </div>
      <div class="stat-detail">{{ estadisticas.desviacionPorcentual.toFixed(2) }}% desviaciÃ³n</div>
    </div>
  </div>

  <!-- Ãrea de Reparto con Drag & Drop -->
  <div class="area-reparto">

    <!-- Propiedades Disponibles (Tabla Maestra) -->
    <div class="columna columna-disponibles">
      <div class="header-columna header-disponibles" [class.destino-activo]="elementoSeleccionado && origenSeleccionado !== 'disponibles'">
        <h3>ğŸ“‹ Propiedades Disponibles</h3>
        <span class="contador">{{ propiedadesDisponibles.length }} propiedades</span>
        <!-- BotÃ³n para mover aquÃ­ cuando hay selecciÃ³n desde heredero -->
        <button
          *ngIf="elementoSeleccionado && origenSeleccionado !== 'disponibles'"
          class="btn-mover-aqui"
          (click)="moverADestino('disponibles')">
          â¬…ï¸ Mover aquÃ­
        </button>
      </div>

      <div class="lista-propiedades">

        <!-- Iterar sobre elementos agrupados -->
        <div
          *ngFor="let elemento of getElementosDisponiblesAgrupados()"
          class="card-propiedad disponible"
          [class.card-grupo]="elemento.esGrupo"
          [class.seleccionado]="estaSeleccionado(elemento)"
          (dblclick)="seleccionarElemento(elemento, 'disponibles')">

          <div class="propiedad-info">
            <!-- Vista de GRUPO -->
            <ng-container *ngIf="elemento.esGrupo">
              <div class="grupo-header">
                <span class="badge-grupo-grande">ğŸ·ï¸ {{ elemento.codGrupo }}</span>
                <span class="grupo-count">{{ elemento.propiedades.length }} propiedades</span>
              </div>
              <div class="propiedad-detalle">
                <span class="badge" [class.badge-rustico]="elemento.tipoMayoritario === 'rustico'" [class.badge-urbano]="elemento.tipoMayoritario === 'urbano'">
                  {{ elemento.tipoMayoritario === 'rustico' ? 'ğŸŒ¾ RÃºsticas' : 'ğŸ  Urbanas' }}
                </span>
              </div>
              <div class="grupo-propiedades-lista">
                <span *ngFor="let p of elemento.propiedades; let last = last" class="grupo-ref-mini">
                  {{ p.propiedad.referencia_catastral }}{{ !last ? ', ' : '' }}
                </span>
              </div>
            </ng-container>

            <!-- Vista de PROPIEDAD INDIVIDUAL -->
            <ng-container *ngIf="!elemento.esGrupo">
              <div class="propiedad-ref">{{ elemento.propiedades[0].propiedad.referencia_catastral }}</div>
              <div class="propiedad-detalle">
                <span class="badge" [class.badge-rustico]="elemento.tipoMayoritario === 'rustico'" [class.badge-urbano]="elemento.tipoMayoritario === 'urbano'">
                  {{ elemento.tipoMayoritario === 'rustico' ? 'ğŸŒ¾ RÃºstica' : 'ğŸ  Urbana' }}
                </span>
                <span class="municipio">{{ elemento.propiedades[0].propiedad.localizacion?.municipio }}</span>
              </div>
              <div class="propiedad-ubicacion" *ngIf="elemento.propiedades[0].propiedad.localizacion?.partida">
                <span class="label-small">Partida:</span>
                <span class="valor-small">{{ elemento.propiedades[0].propiedad.localizacion.partida }}</span>
              </div>
              <!-- Mostrar los 3 valores -->
              <div class="propiedad-tres-valores">
                <div class="valor-item">
                  <span class="valor-label">Calc:</span>
                  <span class="valor-dato">{{ formatCurrency(elemento.propiedades[0].valoracion?.valor_estimado_euros) }}</span>
                </div>
                <div class="valor-item">
                  <span class="valor-label">Cat:</span>
                  <span class="valor-dato">{{ elemento.propiedades[0].propiedad.valor_referencia ? formatCurrency(elemento.propiedades[0].propiedad.valor_referencia) : '-' }}</span>
                </div>
                <div class="valor-item" [class.valor-manual-activo]="elemento.propiedades[0].propiedad.precioManual">
                  <span class="valor-label">Man:</span>
                  <span class="valor-dato">{{ elemento.propiedades[0].propiedad.precioManual ? formatCurrency(elemento.propiedades[0].propiedad.precioManual) : '-' }}</span>
                </div>
              </div>
              <div class="propiedad-validado" *ngIf="elemento.propiedades[0].propiedad.precioValidado">
                <span class="badge-validado">âœ“ Validado</span>
              </div>
            </ng-container>

            <!-- Valores (comÃºn para ambos) -->
            <div class="propiedad-valores">
              <div class="valor-principal">{{ formatCurrency(elemento.valorTotal) }}</div>
              <div class="superficie">{{ formatNumber(elemento.superficieTotal, 4) }} ha</div>
            </div>
          </div>
        </div>

        <div class="mensaje-vacio" *ngIf="propiedadesDisponibles.length === 0">
          <p>âœ… Todas las propiedades han sido asignadas</p>
        </div>
      </div>
    </div>

    <!-- Columnas de Herederos -->
    <div class="columnas-herederos">
      <div class="columna columna-heredero" *ngFor="let heredero of herederos">

        <div class="header-columna header-heredero"
             [class.heredero-activo]="heredero.propiedades.length > 0"
             [class.destino-activo]="elementoSeleccionado && origenSeleccionado !== heredero">
          <div class="heredero-titulo">
            <h3>{{ heredero.nombre }}</h3>
            <input
              type="text"
              [(ngModel)]="heredero.nombre"
              class="input-nombre-heredero"
              placeholder="Nombre del heredero">
          </div>

          <!-- BotÃ³n para mover aquÃ­ cuando hay selecciÃ³n -->
          <button
            *ngIf="elementoSeleccionado && origenSeleccionado !== heredero"
            class="btn-mover-aqui"
            (click)="moverADestino(heredero)">
            â¡ï¸ Mover aquÃ­
          </button>

          <div class="heredero-resumen">
            <div class="resumen-item">
              <span class="label">Valor:</span>
              <span class="value">{{ formatCurrency(heredero.valorTotal) }}</span>
            </div>
            <div class="resumen-item">
              <span class="label">Propiedades:</span>
              <span class="value">{{ heredero.propiedades.length }}</span>
            </div>
            <div class="resumen-item pequeÃ±o">
              <span class="badge badge-rustico-small">ğŸŒ¾ {{ heredero.cantidadRusticas }}</span>
              <span class="badge badge-urbano-small">ğŸ  {{ heredero.cantidadUrbanas }}</span>
            </div>
          </div>
        </div>

        <div class="lista-propiedades lista-heredero">

          <!-- Iterar sobre elementos agrupados del heredero -->
          <div
            *ngFor="let elemento of getElementosHerederoAgrupados(heredero)"
            class="card-propiedad asignada"
            [class.card-grupo]="elemento.esGrupo"
            [class.seleccionado]="estaSeleccionado(elemento)"
            (dblclick)="seleccionarElemento(elemento, heredero)">

            <div class="propiedad-info">
              <!-- Vista de GRUPO -->
              <ng-container *ngIf="elemento.esGrupo">
                <div class="grupo-header">
                  <span class="badge-grupo-grande">ğŸ·ï¸ {{ elemento.codGrupo }}</span>
                  <span class="grupo-count">{{ elemento.propiedades.length }} props</span>
                </div>
                <div class="propiedad-detalle">
                  <span class="badge" [class.badge-rustico]="elemento.tipoMayoritario === 'rustico'" [class.badge-urbano]="elemento.tipoMayoritario === 'urbano'">
                    {{ elemento.tipoMayoritario === 'rustico' ? 'ğŸŒ¾' : 'ğŸ ' }}
                  </span>
                </div>
                <div class="grupo-propiedades-lista">
                  <span *ngFor="let p of elemento.propiedades; let last = last" class="grupo-ref-mini">
                    {{ p.propiedad.referencia_catastral }}{{ !last ? ', ' : '' }}
                  </span>
                </div>
              </ng-container>

              <!-- Vista de PROPIEDAD INDIVIDUAL -->
              <ng-container *ngIf="!elemento.esGrupo">
                <div class="propiedad-ref">{{ elemento.propiedades[0].propiedad.referencia_catastral }}</div>
                <div class="propiedad-detalle">
                  <span class="badge" [class.badge-rustico]="elemento.tipoMayoritario === 'rustico'" [class.badge-urbano]="elemento.tipoMayoritario === 'urbano'">
                    {{ elemento.tipoMayoritario === 'rustico' ? 'ğŸŒ¾' : 'ğŸ ' }}
                  </span>
                  <span class="municipio">{{ elemento.propiedades[0].propiedad.localizacion?.municipio }}</span>
                </div>
                <div class="propiedad-ubicacion" *ngIf="elemento.propiedades[0].propiedad.localizacion?.partida">
                  <span class="label-small">Partida:</span>
                  <span class="valor-small">{{ elemento.propiedades[0].propiedad.localizacion.partida }}</span>
                </div>
                <!-- Mostrar los 3 valores -->
                <div class="propiedad-tres-valores">
                  <div class="valor-item">
                    <span class="valor-label">Calc:</span>
                    <span class="valor-dato">{{ formatCurrency(elemento.propiedades[0].valoracion?.valor_estimado_euros) }}</span>
                  </div>
                  <div class="valor-item">
                    <span class="valor-label">Cat:</span>
                    <span class="valor-dato">{{ elemento.propiedades[0].propiedad.valor_referencia ? formatCurrency(elemento.propiedades[0].propiedad.valor_referencia) : '-' }}</span>
                  </div>
                  <div class="valor-item" [class.valor-manual-activo]="elemento.propiedades[0].propiedad.precioManual">
                    <span class="valor-label">Man:</span>
                    <span class="valor-dato">{{ elemento.propiedades[0].propiedad.precioManual ? formatCurrency(elemento.propiedades[0].propiedad.precioManual) : '-' }}</span>
                  </div>
                </div>
                <div class="propiedad-validado" *ngIf="elemento.propiedades[0].propiedad.precioValidado">
                  <span class="badge-validado">âœ“ Validado</span>
                </div>
              </ng-container>

              <!-- Valores (comÃºn para ambos) -->
              <div class="propiedad-valores">
                <div class="valor-principal">{{ formatCurrency(elemento.valorTotal) }}</div>
                <div class="superficie">{{ formatNumber(elemento.superficieTotal, 4) }} ha</div>
              </div>
            </div>
          </div>

          <div class="mensaje-vacio-heredero" *ngIf="heredero.propiedades.length === 0">
            <p>ğŸ‘† Haz doble click en una propiedad y luego "Mover aquÃ­"</p>
          </div>
        </div>

        <!-- Total del Heredero -->
        <div class="footer-heredero">
          <div class="total-label">Total:</div>
          <div class="total-value">{{ formatCurrency(heredero.valorTotal) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de selecciÃ³n activa -->
  <div class="panel-seleccion" *ngIf="elementoSeleccionado">
    <div class="seleccion-info">
      <span class="seleccion-icono">âœ‹</span>
      <div class="seleccion-texto">
        <strong>Elemento seleccionado:</strong>
        <span *ngIf="elementoSeleccionado.esGrupo">
          Grupo "{{ elementoSeleccionado.codGrupo }}" ({{ elementoSeleccionado.propiedades.length }} propiedades)
        </span>
        <span *ngIf="!elementoSeleccionado.esGrupo">
          {{ elementoSeleccionado.propiedades[0].propiedad.referencia_catastral }}
        </span>
        - {{ formatCurrency(elementoSeleccionado.valorTotal) }}
      </div>
    </div>
    <button class="btn btn-cancelar-seleccion" (click)="cancelarSeleccion()">
      âœ– Cancelar
    </button>
  </div>

  <!-- InformaciÃ³n de Ayuda -->
  <div class="info-ayuda">
    <div class="ayuda-item" *ngIf="!elementoSeleccionado">
      <strong>ğŸ’¡ Consejo:</strong> Haz doble click en una propiedad para seleccionarla y luego elige el destino
    </div>
    <div class="ayuda-item" *ngIf="elementoSeleccionado">
      <strong>ğŸ‘† AcciÃ³n:</strong> Haz click en "Mover aquÃ­" en el heredero destino o en "Disponibles"
    </div>
    <div class="ayuda-item">
      <strong>ğŸ¤– Reparto AutomÃ¡tico:</strong> Distribuye las propiedades de forma equilibrada segÃºn el criterio seleccionado
    </div>
    <div class="ayuda-item">
      <strong>âš–ï¸ Balance:</strong> El sistema intenta equilibrar tanto el valor como el tipo de propiedades
    </div>
  </div>
</div>

<!-- Modal Guardar Reparto -->
<div class="modal-overlay" *ngIf="mostrarModalGuardar" (click)="cerrarModalGuardar()">
  <div class="modal-contenido modal-guardar" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ’¾ Guardar Reparto</h3>
      <button class="btn-cerrar" (click)="cerrarModalGuardar()">âœ–</button>
    </div>

    <div class="modal-body">
      <div class="campo">
        <label for="nombreReparto">Nombre del reparto: *</label>
        <input
          type="text"
          id="nombreReparto"
          [(ngModel)]="nombreReparto"
          placeholder="Ej: Reparto Principal"
          class="input-texto"
          maxlength="100">
      </div>

      <div class="campo">
        <label for="descripcionReparto">DescripciÃ³n (opcional):</label>
        <textarea
          id="descripcionReparto"
          [(ngModel)]="descripcionReparto"
          placeholder="Agrega notas o comentarios sobre este reparto"
          class="input-textarea"
          rows="4"
          maxlength="500"></textarea>
      </div>

      <div class="info-guardado" *ngIf="repartoActualId">
        <small>
          â„¹ï¸ Este reparto ya estÃ¡ guardado. Al guardar nuevamente se actualizarÃ¡.
        </small>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="cerrarModalGuardar()" class="btn btn-secondary">
        Cancelar
      </button>
      <button (click)="guardarReparto()" class="btn btn-primary">
        <span *ngIf="!repartoActualId">ğŸ’¾ Guardar</span>
        <span *ngIf="repartoActualId">ğŸ’¾ Actualizar</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal Cargar Reparto -->
<div class="modal-overlay" *ngIf="mostrarModalCargar" (click)="cerrarModalCargar()">
  <div class="modal-contenido modal-cargar" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“‚ Cargar Reparto</h3>
      <button class="btn-cerrar" (click)="cerrarModalCargar()">âœ–</button>
    </div>

    <div class="modal-body">
      <div class="lista-repartos" *ngIf="repartosGuardados.length > 0">
        <div
          class="item-reparto"
          *ngFor="let reparto of repartosGuardados"
          (click)="cargarReparto(reparto)">
          <div class="item-header">
            <div class="item-nombre">{{ reparto.nombre }}</div>
            <button
              class="btn-eliminar-mini"
              (click)="eliminarRepartoGuardado(reparto, $event)"
              title="Eliminar reparto">
              ğŸ—‘ï¸
            </button>
          </div>

          <div class="item-info" *ngIf="reparto.descripcion">
            <small>{{ reparto.descripcion }}</small>
          </div>

          <div class="item-detalles">
            <span class="detalle-badge">
              ğŸ‘¥ {{ reparto.herederos.length }} herederos
            </span>
            <span class="detalle-badge">
              ğŸ’¶ {{ formatCurrency(reparto.estadisticas.valorTotal) }}
            </span>
            <span class="detalle-badge" *ngIf="reparto.estadisticas.equilibrado">
              âœ… Equilibrado
            </span>
            <span class="detalle-badge desequilibrado" *ngIf="!reparto.estadisticas.equilibrado">
              âš ï¸ Desequilibrado
            </span>
          </div>

          <div class="item-fecha">
            <small>ğŸ“… {{ formatDate(reparto.fechaModificacion || reparto.fechaCreacion) }}</small>
          </div>
        </div>
      </div>

      <div class="sin-repartos" *ngIf="repartosGuardados.length === 0">
        <p>ğŸ“­ No hay repartos guardados</p>
        <small>Crea un reparto y guÃ¡rdalo para verlo aquÃ­</small>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="cerrarModalCargar()" class="btn btn-secondary">
        Cerrar
      </button>
    </div>
  </div>
</div>
